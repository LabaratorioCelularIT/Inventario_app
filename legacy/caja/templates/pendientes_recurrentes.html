<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Pendientes recurrentes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:#f6f8fb;margin:0;color:#111}
    .wrap{max-width:1100px;margin:24px auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.06)}
    h1{margin:0 0 12px}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid #e6e9ef;padding:10px;text-align:left;vertical-align:top}
    th{background:#0d6efd;color:#fff}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .on{background:#dcfce7;color:#166534}
    .off{background:#fee2e2;color:#991b1b}
    .btn{background:#0d6efd;color:#fff;border:none;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn:hover{filter:brightness(.96)}
    .muted{color:#667085}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <h1 style="flex:1">Pendientes recurrentes</h1>
      <a class="btn" href="/crear-pendiente">âž• Nueva regla / pendiente</a>
      <a class="btn" href="/pendientes">ðŸ“‹ Ver pendientes</a>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Estado</th>
          <th>Frecuencia</th>
          <th>ProgramaciÃ³n</th>
          <th>PrÃ³ximo disparo</th>
          <th>Datos</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for r in reglas %}
        <tr id="row-{{ r.id }}">
          <td>#{{ r.id }}</td>
          <td>
            {% if r.activo %}<span class="badge on">Activo</span>{% else %}<span class="badge off">Inactivo</span>{% endif %}
            <div class="muted">Creado por: {{ r.creado_por or '-' }}</div>
          </td>
          <td>{{ r.frecuencia|default('diario')|capitalize }}</td>
          <td>
            {% if r.frecuencia == 'semanal' %}
              DÃ­a semana: {{ r.dia_semana }} (0=Lun)
            {% elif r.frecuencia == 'mensual' %}
              DÃ­a mes: {{ r.dia_mes }}
            {% else %}
              Diario
            {% endif %}
            <div>Hora: {{ r.hora or '09:00' }} ({{ r.tz or 'America/Monterrey' }})</div>
          </td>
          <td>
            {{ r.next_run or '-' }}
            <div class="muted">Ãšltimo: {{ r.ultimo_disparo or '-' }}</div>
          </td>
          <td style="max-width:360px">
            <div><b>Tipo:</b> {{ r.tipo }}</div>
            <div><b>Ref:</b> {{ r.referencia or '-' }}</div>
            <div><b>Sucursal:</b> {{ r.sucursal or '-' }}</div>
            <pre class="muted" style="white-space:pre-wrap">{{ r.detalle_json }}</pre>
          </td>
          <td>
            {% if soy_admin %}
            <button class="btn" onclick="toggleRegla({{ r.id }})">
              {% if r.activo %}Desactivar{% else %}Activar{% endif %}
            </button>
            {% else %}
            <span class="muted">Solo admin</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    async function toggleRegla(id){
      if(!confirm('Â¿Cambiar estado de la regla #' + id + '?')) return;
      const res = await fetch(`/pendientes-recurrentes/${id}/toggle`, {method:'POST'});
      if(res.ok){
        location.reload();
      }else{
        alert('No se pudo cambiar el estado.');
      }
    }
  </script>
</body>
</html>
