<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Punto de Venta - {{ sucursal }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="{{ url_for('static', filename='logo.png') }}">
  <style>
    :root { --bg:#e6f0ff; --card:#ffffff; --fg:#003366; --accent:#337ab7; --accent-hover:#286090; --danger:#d9534f; --danger-hover:#c9302c; }

    body { margin:0; padding:0; font-family:'Segoe UI', Tahoma, sans-serif; background-color:var(--bg); color:var(--fg); }

    .topbar { background-color:var(--fg); padding:20px; display:flex; align-items:center; justify-content:center; border-bottom:3px solid #001f3f; box-shadow:0 2px 10px rgba(0,0,0,0.25); position:relative; }
    .topbar img { height:70px; margin-right:15px; }
    .topbar .title { font-size:26px; font-weight:bold; color:white; display:flex; align-items:center; }
    .logout { position:absolute; top:20px; right:20px; background-color:var(--danger); color:white; padding:10px 16px; border:none; border-radius:6px; font-size:15px; text-decoration:none; font-weight:bold; transition:background-color .3s ease; }
    .logout:hover { background-color:var(--danger-hover); }

    .main { padding:30px 20px; max-width:900px; margin:auto; }
    .section { background-color:var(--card); border-radius:12px; padding:30px; box-shadow:0 6px 20px rgba(0,0,0,0.1); text-align:center; }

    .section h2 { margin-top:0; color:var(--fg); font-size:24px; margin-bottom:30px; }

    .btn { display:inline-block; margin:14px; padding:16px 28px; background-color:var(--accent); color:white !important; text-decoration:none; border-radius:10px; font-size:18px; transition:background-color .3s ease, transform .1s ease; font-weight:bold; min-width:240px; box-shadow:0 4px 10px rgba(0,0,0,0.06); }
    .btn:hover { background-color:var(--accent-hover); transform:translateY(-1px); }
    .btn:active { transform:translateY(0); }

    .btn-link { display:inline-flex; align-items:center; justify-content:center; gap:8px; background:var(--accent); color:#fff !important; padding:12px 18px; border-radius:10px; font-weight:bold; text-decoration:none; font-size:18px; margin:10px; min-width:240px; box-shadow:0 4px 10px rgba(0,0,0,0.06); transition:background-color .2s ease, transform .1s ease; }
    .btn-link:hover { background:var(--accent-hover); transform:translateY(-1px); }

    #badge-mios { display:none; background:#e11d48; color:#fff; border-radius:999px; padding:2px 8px; font-size:12px; margin-left:8px; }

    @media (max-width:600px) {
      .topbar .title { flex-direction:column; font-size:20px; text-align:center; }
      .topbar img { height:60px; margin-bottom:10px; }
      .btn { width:100%; margin:10px 0; font-size:17px; padding:16px; }
      .btn-link { width:100%; margin:10px 0; }
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="title">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
      Celulares Cr√©dito F√°cil ‚Äì Punto de Venta ({{ sucursal }})
    </div>
    <a class="logout" href="/logout">Cerrar sesi√≥n</a>
  </div>

  <div class="main">
    <div class="section">
      <h2>{{ nombre_real }} ‚Äì Sucursal: {{ sucursal }}</h2>

      <a href="/ventas" class="btn">üõí Registrar venta</a>
      <a href="/gastos" class="btn">üì§ Registrar salida</a>
      <a href="/nota" class="btn">üìù Agregar nota</a>
      <a href="/corte-del-dia" class="btn">üíµ Corte del d√≠a</a>
      <a href="/reporte-excel" class="btn">‚¨áÔ∏è Descargar Excel</a>
      <a href="/feria" class="btn">üí∞ Feria</a>
      <a class="btn-link" href="/crear-pendiente">‚ûï Crear Pendiente</a>
      <a class="btn-link" href="/mis-pendientes">üßë‚Äçüíº Mis Pendientes <span id="badge-mios">0</span></a>
      <a href="/ir-inventario" class="btn">üìã Ir a Inventario</a>
    </div>
  </div>

  {% if tipo in ['consulta', 'reparto'] %}
  <div id="sesion-alerta" style="position: fixed; bottom: 20px; right: 20px; background: #003366; color: white; padding: 15px; border-radius: 8px; z-index: 9999; display: none;">
    ‚è≥ Tiempo restante: <span id="contador-tiempo">--:--</span>
    <button onclick="a√±adirTiempo()" style="margin-left: 10px; background-color: orange; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">+10 min</button>
  </div>
  {% endif %}

  <script>
    const POLL_MS = 30000;
    let lastMine = null;

    function requestNotifPermission(){
      if("Notification" in window && Notification.permission!=="granted"){
        Notification.requestPermission().catch(()=>{});
      }
    }
    function notifyMine(n){
      if("Notification" in window && Notification.permission==="granted"){
        new Notification("Nuevo pendiente asignado", {
          body: `Tienes ${n} pendientes.`,
          icon: "{{ url_for('static', filename='logo.png') }}"
        });
      }
    }

    async function pollMine(){
      try{
        const r = await fetch('/mis-pendientes-resumen-json');
        const j = await r.json();
        if(!j.ok) return;
        const n = Number(j.total||0);
        const badge = document.getElementById('badge-mios');
        if(badge){
          badge.textContent = n;
          badge.style.display = n>0 ? 'inline-block' : 'none';
        }
        if(lastMine!==null && n>lastMine){ notifyMine(n); }
        lastMine = n;
      }catch(e){}
    }

    requestNotifPermission();
    pollMine();
    setInterval(pollMine, POLL_MS);
  </script>

  <script>
    const tipo = "{{ tipo }}";
    if (["consulta", "reparto"].includes(tipo)) {
      let segundos_restantes = 4 * 60 * 60;
      let aviso_mostrado = false;

      if ("Notification" in window && Notification.permission !== "granted") {
        Notification.requestPermission();
      }

      function mostrarNotificacion() {
        if ("Notification" in window && Notification.permission === "granted") {
          new Notification("‚è≥ Sesi√≥n por expirar", {
            body: "Tu sesi√≥n terminar√° pronto. Da clic para extender.",
            icon: "{{ url_for('static', filename='logo.png') }}"
          });
        }
        if ("vibrate" in navigator) { navigator.vibrate([400, 200, 400]); }
      }

      function actualizarContador() {
        const minutos = Math.floor(segundos_restantes / 60);
        const segundos = segundos_restantes % 60;
        const contador = document.getElementById("contador-tiempo");
        if (contador) { contador.textContent = `${String(minutos).padStart(2,'0')}:${String(segundos).padStart(2,'0')}`; }

        if (segundos_restantes <= 30 && !aviso_mostrado) {
          const alerta = document.getElementById("sesion-alerta");
          if (alerta) alerta.style.display = "block";
          mostrarNotificacion();
          aviso_mostrado = true;
        }
        if (segundos_restantes <= 0) { window.location.href = "/logout"; }
        segundos_restantes--;
      }

      window.a√±adirTiempo = function () {
        segundos_restantes += 10 * 60;
        aviso_mostrado = false;
        const alerta = document.getElementById("sesion-alerta");
        if (alerta) alerta.style.display = "none";
      }

      setInterval(actualizarContador, 1000);
    }
  </script>
</body>
</html>