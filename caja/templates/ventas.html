<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar Ventas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #e6f0ff;
      --card: #ffffff;
      --fg: #003366;
      --accent: #337ab7;
      --accent-hover: #286090;
      --danger: #d9534f;
      --danger-hover: #c9302c;
    }
    body { background-color: var(--bg); font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 0; color: #000; }
    .topbar { background-color: var(--fg); padding: 20px; display: flex; justify-content: center; align-items: center; border-bottom: 3px solid #001f3f; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25); position: relative; }
    .topbar img { height: 70px; margin-right: 15px; }
    .topbar .title { font-size: 26px; font-weight: bold; color: #ffffff; display: flex; align-items: center; }
    .volver-btn { position: absolute; top: 20px; left: 20px; background-color: var(--danger); color: white; padding: 10px 16px; text-decoration: none; border-radius: 6px; font-weight: bold; z-index: 999; }
    .volver-btn:hover { background-color: var(--danger-hover); }
    .container { padding: 30px 20px; max-width: 1000px; margin: auto; }
    h2 { text-align: center; color: var(--fg); font-size: 24px; margin-bottom: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { width: 100%; padding: 10px 12px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; height: 44px; box-sizing: border-box; background-color: #fff; }
    .btn { background-color: var(--accent); color: white; padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; margin-top: 15px; cursor: pointer; }
    .btn:hover { background-color: var(--accent-hover); }
    .btn-red { background-color: var(--danger); }
    .btn-red:hover { background-color: var(--danger-hover); }
    table { width: 100%; border-collapse: collapse; background-color: var(--card); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: center; }
    th { background-color: var(--accent); color: white; }
    .section { background-color: var(--card); border-radius: 10px; padding: 20px; margin-top: 30px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); }
    .total-pagar { text-align: center; font-size: 24px; font-weight: bold; margin-top: 20px; padding: 12px; background-color: #cce5ff; color: var(--fg); border: 2px solid #99c2ff; border-radius: 8px; box-shadow: 2px 2px 6px rgba(0,0,0,0.1); }
    @media (max-width: 600px) {
      .topbar .title { flex-direction: column; font-size: 20px; }
      .topbar img { height: 60px; margin-bottom: 10px; }
    }
  </style>
</head>
<body>
<a class="volver-btn" href="{{ '/panel-admin' if tipo == 'admin' else '/panel-consulta' }}">‚¨Ö Volver al Panel</a>

<div class="topbar">
  <div class="title">
    <img src="/static/logo.png" alt="Logo">
    Celulares Cr√©dito F√°cil - Registrar Ventas
  </div>
</div>

<div class="container">
  {% if tipo == 'admin' %}
  <div class="section">
    <h2>Filtros de b√∫squeda</h2>
    <form method="GET" id="filtrosForm">
      <label>Filtrar por fecha:</label>
      <input type="date" name="fecha" value="{{ fecha }}" onchange="document.getElementById('filtrosForm').submit()">
      <label>Filtrar por sucursal:</label>
      <select name="sucursal" onchange="document.getElementById('filtrosForm').submit()">
        {% for suc in sucursales %}
        <option value="{{ suc }}" {% if suc == sucursal_filtro %}selected{% endif %}>{{ suc }}</option>
        {% endfor %}
      </select>
    </form>
  </div>
  {% endif %}

  <h2>Agregar producto</h2>
  <form action="/ventas" method="POST">
    <input type="hidden" name="fecha" value="{{ fecha }}">
    <input type="hidden" name="sucursal" value="{{ sucursal_filtro }}">
    <label>Descripci√≥n del producto (Feria, Pago, Venta o Enganche):</label>
    <input type="text" name="descripcion" required>
    <label>Financiera:</label>
    <select name="tipo" required>
      <option value="PayJoy">PayJoy</option>
      <option value="Lespago">Lespago</option>
      <option value="Reparacion">Reparacion</option>
      <option value="Accesorios">Accesorios</option>
      <option value="Ventacontado">Ventacontado</option>
      <option value="Otro">Otro</option>
    </select>
    <label>Concepto:</label>
    <select name="concepto" required>
      <option value="Parcialidad">Parcialidad</option>
      <option value="Enganche">Enganche</option>
      <option value="Otro">Otro</option>
    </select>
    <label>IMEI (si aplica):</label>
    <input type="text" name="imei">
    <label>Tipo de pago:</label>
    <select name="tipo_pago" required>
      <option value="Efectivo">Efectivo</option>
      <option value="Tarjeta">Tarjeta</option>
      <option value="D√≥lar">D√≥lar</option>
      <option value="Mixto">Mixto</option>
    </select>
    <label>Referencia:</label>
    <input type="text" name="referencia">
    <label>Precio a pagar:</label>
    <input type="number" step="1" name="precio" required>
    <button class="btn" type="submit">Agregar producto</button>
    <a href="{{ url_for('ultimo_ticket') }}" class="btn">üîÅ Reimprimir √∫ltimo ticket</a>
  </form>

  {% if carrito %}
  <div class="section">
    <h2>Lista de productos</h2>
    <table>
      <thead>
        <tr>
          <th>Descripci√≥n</th>
          <th>Concepto</th>
          <th>Tipo</th>
          <th>Precio</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody>
        {% for item in carrito %}
        <tr data-index="{{ loop.index0 }}">
          <td>{{ item.descripcion }}</td>
          <td>{{ item.concepto }}</td>
          <td>{{ item.tipo }}</td>
          <td>${{ '%.2f'|format(item.precio) }}</td>
          <td><button class="btn btn-red" onclick="eliminarVenta(event, {{ loop.index0 }})">X</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <p class="total-pagar" id="totalPagar">Total: ${{ '%.2f'|format(total) }}</p>
  </div>

  <div class="section">
    <h2>M√©todos de pago</h2>
    <form action="/cobrar" method="POST" onsubmit="return calcularCambio()">
      {% if tipo == 'admin' %}
        <label>Sucursal de la venta:</label>
        <select name="sucursal_manual">
          {% for suc in sucursales %}
          <option value="{{ suc }}" {% if suc == sucursal_filtro %}selected{% endif %}>{{ suc }}</option>
          {% endfor %}
        </select>
        <label>Fecha de la venta:</label>
        <input type="date" name="fecha_manual" value="{{ fecha }}">
      {% endif %}
      <label>Efectivo:</label>
      <input type="number" step="1" name="efectivo" id="efectivo" value="0">
      <label>Tarjeta:</label>
      <input type="number" step="1" name="tarjeta" id="tarjeta" value="0">
      <label>D√≥lares:</label>
      <input type="number" step="1" name="dolares" id="dolares" value="0">
      <label>Tipo de cambio:</label>
      <input type="number" step="0.01" name="dolar" id="dolar" value="0">
      <label>Referencia general (opcional):</label>
      <input type="text" name="referencia">
      <p id="resultadoCambio"></p>
      <button class="btn" type="submit">Cobrar</button>
    </form>
  </div>
  {% endif %}

  {% if ventas %}
  <div class="section">
    <h2>Ventas registradas</h2>
    <table>
      <thead>
        <tr>
          <th>Descripci√≥n</th>
          <th>Concepto</th>
          <th>Tipo</th>
          <th>Referencia</th>
          <th>Precio</th>
          <th>Imprimir</th>
          {% if tipo == 'admin' %}<th>Eliminar</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for venta in ventas %}
        <tr id="venta-{{ venta.id }}">
          <td>{{ venta.descripcion }}</td>
          <td>{{ venta.concepto }}</td>
          <td>{{ venta.tipo }}</td>
          <td>{{ venta.referencia }}</td>
          <td>${{ '%.2f'|format(venta.precio) }}</td>
          <td>
            <button onclick="imprimirTicketDesdeFila(
              '{{ venta.descripcion }}',
              '{{ venta.concepto }}',
              '{{ venta.tipo }}',
              '{{ venta.referencia }}',
              '{{ '%.2f'|format(venta.precio) }}'
            )">üñ®Ô∏è</button>
          </td>
          {% if tipo == 'admin' %}
          <td><button class="btn btn-red" onclick="eliminarVentaAdmin({{ venta.id }})">X</button></td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>

<script>
  function eliminarVenta(event, index) {
    event.preventDefault();
    fetch('/eliminar-item', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ index: index })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        document.querySelector(`tr[data-index='${index}']`).remove();
        document.getElementById('totalPagar').innerText = `Total: $${data.total.toFixed(2)}`;
      }
    });
  }

  function eliminarVentaAdmin(id) {
    if (!confirm("¬øSeguro que deseas eliminar esta venta?")) return;
    fetch(`/eliminar-venta-admin/${id}`, { method: 'POST' })
      .then(r => r.json())
      .then(data => {
        if (data.success) document.getElementById(`venta-${id}`).remove();
        else alert("Error al eliminar la venta.");
      });
  }

  function calcularCambio() {
    const efectivo = parseFloat(document.getElementById('efectivo').value) || 0;
    const tarjeta  = parseFloat(document.getElementById('tarjeta').value)  || 0;
    const dolares  = parseFloat(document.getElementById('dolares').value)  || 0;
    const tipoCambio = parseFloat(document.getElementById('dolar').value) || 0;
    const total = parseFloat("{{ total|default(0) }}");
    const pagoTotal = efectivo + tarjeta + (dolares * tipoCambio);
    const cambio = pagoTotal - total;
    const lbl = document.getElementById('resultadoCambio');
    if (cambio >= 0) { lbl.style.color = "green"; lbl.innerText = `Cambio a regresar: $${cambio.toFixed(2)}`; return true; }
    lbl.style.color = "red"; lbl.innerText = `Falta por pagar: $${Math.abs(cambio).toFixed(2)}`; return false;
  }

  ["efectivo", "tarjeta", "dolares", "dolar"].forEach(id => {
    const el = document.getElementById(id); if (el) el.addEventListener("input", calcularCambio);
  });

  function imprimirTicketDesdeFila(descripcion, concepto, financiera, referencia, precio) {
    const contenido =
`Celulares Cr√©dito F√°cil
Sucursal: {{ sucursal_filtro }}
Fecha: {{ fecha }}

Producto: ${descripcion}
Concepto: ${concepto}
Financiera: ${financiera}
Ref: ${referencia}
Precio: $${precio}

Total: $${precio}
Pagado: $${precio}
Cambio: $0.00

¬°Gracias por su compra!`;
    fetch("http://localhost:5500/imprimir", { method: "POST", headers: { "Content-Type": "text/plain" }, body: contenido })
      .then(r => { if (!r.ok) throw new Error("Error en la impresi√≥n"); })
      .catch(err => alert("Error al imprimir: " + err.message));
  }
</script>
</body>
</html>
