<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Crear Pendiente</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{--bg:#e6f0ff;--card:#fff;--fg:#003366;--accent:#337ab7}
body{margin:0;font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--fg)}
.wrap{max-width:820px;margin:24px auto;background:var(--card);padding:20px;border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.08)}
label{font-weight:600;margin-top:10px;display:block}
input,select,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px}
button{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;margin-top:14px;cursor:pointer}
.helper{font-size:12px;color:#6b7280;margin-top:6px}
#inv-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
#inv-count{margin-left:auto;font-weight:600}
#inv-chips{display:flex;gap:6px;flex-wrap:wrap}
.inv-chip{background:#e6f0ff;border:1px solid #c9d7f2;padding:4px 8px;border-radius:999px;font-size:12px;display:inline-flex;gap:6px;align-items:center}
.inv-chip button{background:transparent;border:none;color:#1f2937;cursor:pointer;padding:0;margin:0;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <h2>Crear pendiente</h2>
  <form method="post">
    <label for="tipo">Tipo</label>
    <select name="tipo" id="tipo">
      <option value="otro">Otro</option>
      <option value="registro_usuario">Registro de usuario</option>
      <option value="feria">Feria</option>
    </select>

    <label for="referencia">Referencia</label>
    <input id="referencia" name="referencia">

    <label for="sucursal">Sucursal</label>
    <select name="sucursal" id="sucursal" required>
      {% for s in sucursales %}
        <option value="{{ s }}" {% if s == sucursal_default %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>

    <label for="detalle">Detalle (texto o JSON)</label>
    <textarea id="detalle" name="detalle" rows="5" placeholder='Ej. {"nota":"texto"} o texto libre'></textarea>

    <label for="involucrados">Involucrados</label>
    <div style="display:grid;gap:8px">
      <input id="filtro-inv" type="text" placeholder="Buscar… (por nombre o usuario)">
      <select id="involucrados" name="involucrados" multiple size="10">
        {% for u in usuarios %}
          <!-- value = username interno | texto visible = nombre real -->
          <option value="{{ u.usuario }}" data-username="{{ u.usuario }}">{{ u.nombre }}</option>
        {% endfor %}
      </select>
      <div id="inv-actions">
        <button type="button" id="btn-select-all">Seleccionar todos</button>
        <button type="button" id="btn-clear-all">Limpiar selección</button>
        <span id="inv-count">0 seleccionados</span>
      </div>
      <div id="inv-chips"></div>
      <div class="helper">Consejo: usa <b>Ctrl</b> (Win/Linux) o <b>Cmd</b> (Mac) para elegir varios.</div>
    </div>

    <button type="submit">Crear</button>
  </form>
</div>

<script>
(function () {
  const sel   = document.getElementById('involucrados');
  const chips = document.getElementById('inv-chips');
  const count = document.getElementById('inv-count');
  const filtro= document.getElementById('filtro-inv');
  const btnAll= document.getElementById('btn-select-all');
  const btnClr= document.getElementById('btn-clear-all');

  function updateChips(){
    chips.innerHTML = '';
    const selected = Array.from(sel.selectedOptions).map(o => ({
      v: o.value,             
      t: o.textContent.trim() 
    }));
    count.textContent = `${selected.length} seleccionados`;
    selected.forEach(({v,t})=>{
      const pill = document.createElement('span');
      pill.className = 'inv-chip';
      pill.textContent = t + ' ';
      const x = document.createElement('button');
      x.type = 'button';
      x.textContent = '✕';
      x.onclick = () => {
        const opt = Array.from(sel.options).find(o=>o.value===v);
        if (opt){ opt.selected = false; sel.dispatchEvent(new Event('change')); }
      };
      pill.appendChild(x);
      chips.appendChild(pill);
    });
  }

  sel.addEventListener('change', updateChips);

  filtro.addEventListener('input', ()=>{
    const q = filtro.value.toLowerCase().trim();
    Array.from(sel.options).forEach(o=>{
      const nameMatch = o.textContent.toLowerCase().includes(q);
      const userMatch = (o.dataset.username || o.value).toLowerCase().includes(q);
      o.hidden = !(nameMatch || userMatch);
    });
  });

  btnAll.addEventListener('click', ()=>{
    Array.from(sel.options).forEach(o=>{ if(!o.hidden) o.selected = true; });
    sel.dispatchEvent(new Event('change'));
  });

  btnClr.addEventListener('click', ()=>{
    Array.from(sel.options).forEach(o=> o.selected = false);
    sel.dispatchEvent(new Event('change'));
  });

  updateChips();
})();
</script>
</body>
</html>