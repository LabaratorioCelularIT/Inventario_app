version: '3.8'

services:
  # New Architecture - API
  api:
    build: ./api
    ports:
      - "5000:5000"
    environment:
      - MONGODB_URI=mongodb://mongo:27017/inventario_app
      - JWT_SECRET_KEY=development-secret-key
      - FLASK_ENV=development
    volumes:
      - ./api:/app
      - ./shared/databases:/app/databases
    depends_on:
      - mongo
    networks:
      - inventario-network

  # New Architecture - Frontend
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:5000/api/v1
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - inventario-network

  # MongoDB for new architecture
  mongo:
    image: mongo:7.0
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: inventario_app
    volumes:
      - mongo_data:/data/db
      - ./shared/databases/mongo-init:/docker-entrypoint-initdb.d
    networks:
      - inventario-network

  # Legacy Applications (kept running for business continuity)
  legacy-inventario:
    build: ./legacy/inventario_app
    container_name: inventario_app
    environment:
      FLASK_APP: app.py
      FLASK_RUN_HOST: 0.0.0.0
      FLASK_RUN_PORT: 5001
      FLASK_ENV: production
      INVENTARIO_DB: /app/inventario.sqlite3
    volumes:
      - ./legacy/inventario_app:/app
      - ./inventario.sqlite3:/app/inventario.sqlite3
    command: flask run
    ports:
      - "127.0.0.1:5001:5001"
    restart: unless-stopped
    dns: [8.8.8.8, 1.1.1.1]
    networks:
      - inventario-network

  legacy-caja:
    build: ./legacy/caja
    container_name: caja_app
    environment:
      FLASK_APP: app.py
      FLASK_RUN_HOST: 0.0.0.0
      FLASK_RUN_PORT: 5003
      FLASK_ENV: production
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: "587"
      SMTP_USER: sistemasccfnld@laboratoriocelular.net
      SMTP_PASS: "********"
      SMTP_FROM_NAME: "Celulares Crédito Fácil"
    volumes:
      - ./legacy/caja:/app
      - ./inventario.sqlite3:/app/inventario.sqlite3
    command: flask run
    ports:
      - "127.0.0.1:5003:5003"
    restart: unless-stopped
    dns: [8.8.8.8, 1.1.1.1]
    networks:
      - inventario-network

  legacy-calculadora:
    build: ./legacy/calculadora_cambio
    ports:
      - "5004:5000"
    volumes:
      - ./legacy/calculadora_cambio:/app
      - ./shared/databases:/app/databases
    networks:
      - inventario-network

volumes:
  mongo_data:

networks:
  inventario-network:
    driver: bridge
